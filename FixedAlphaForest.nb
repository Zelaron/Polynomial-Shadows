(* Rodrigues' Descendants: Plot zeros of m-th derivative of P^n *)
(* Based on "Rodrigues' Descendants of a Polynomial and Boutroux Curves" *)
(* by Bøgvad, Hägg, and Shapiro (2023) *)

(* === PARAMETERS === *)
P = (z-1)(z-6)(z-3I);
n = 50;                        (* Exponent *)
m = 50;                        (* Order of derivative; set m = n for \[Alpha] = 1 *)

(* === DERIVED QUANTITIES === *)
d = Exponent[Expand[P], z];
precision = 100;
\[Alpha] = m/n;

(* === COMPUTE ZEROS === *)
(* Zeros of d^m/dz^m [P^n] using high-precision polynomial *)
Pexpanded = Expand[P^n];
derivative = D[Pexpanded, {z, m}];

rootsOfDerivative = {Re@#, Im@#} & /@ 
  (z /. NSolve[derivative == 0, z, WorkingPrecision -> precision]);

(* Zeros of P *)
rootsOfP = {Re@#, Im@#} & /@ 
  (z /. NSolve[P == 0, z, WorkingPrecision -> precision]);

(* Critical points of P (zeros of P') *)
criticalPts = {Re@#, Im@#} & /@ 
  (z /. NSolve[D[P, z] == 0, z, WorkingPrecision -> precision]);

(* === BRANCH POINTS OF SYMBOL CURVE (1.4) === *)
(* Use exact symbolic computation, then solve numerically *)
FF = Sum[(\[Alpha]sym - k)/k! D[P, {z, k}] w^(d - k), {k, 0, d}];
RES = Resultant[FF, D[FF, w], w];
RESatAlpha = RES /. \[Alpha]sym -> \[Alpha];

branchPts = {Re@#, Im@#} & /@ 
  (z /. NSolve[RESatAlpha == 0, z, WorkingPrecision -> precision]);

(* Remove branch points that coincide with zeros of P *)
branchPts = Select[branchPts, 
  Min[EuclideanDistance[#, #2] & @@@ Tuples[{{#}, rootsOfP}]] > 0.01 &];

(* === ISODYNAMIC LINES (for cubic P only) === *)
isodynamicLines = {};
If[d == 3,
  (* Convert roots to complex numbers *)
  a[1] = rootsOfP[[1, 1]] + I rootsOfP[[1, 2]];
  a[2] = rootsOfP[[2, 1]] + I rootsOfP[[2, 2]];
  a[3] = rootsOfP[[3, 1]] + I rootsOfP[[3, 2]];
  
  (* Coefficients for isodynamic point construction *)
  A1 = 18 (a[1]^2 + a[2]^2 + a[3]^2 - a[1] a[2] - a[1] a[3] - a[2] a[3]);
  A2 = (2 a[1] - a[2] - a[3])(a[1] - 2 a[2] + a[3])(a[1] + a[2] - 2 a[3]);
  A3 = -243 ((a[1] - a[2])^2)((a[1] - a[3])^2)((a[2] - a[3])^2);
  A4 = a[1]^2 a[2] + a[1] a[2]^2 + a[1]^2 a[3] + a[1] a[3]^2 + 
       a[2]^2 a[3] + a[2] a[3]^2 - 6 a[1] a[2] a[3];
  
  (* Parametric curves for the two isodynamic lines *)
  curve1[r_] := (1/A1)((A2 - Sqrt[A3]) r + Sqrt[A3] + 9 A4);
  curve2[r_] := (1/A1)((A2 + Sqrt[A3]) r - Sqrt[A3] + 9 A4);
  
  (* Get two points on each line *)
  pt1A = {Re@#, Im@#} &@curve1[0];
  pt1B = {Re@#, Im@#} &@curve1[1];
  pt2A = {Re@#, Im@#} &@curve2[0];
  pt2B = {Re@#, Im@#} &@curve2[1];
  
  isodynamicLines = {
    {Black, InfiniteLine[{pt1A, pt1B}]},
    {Black, Dashed, InfiniteLine[{pt2A, pt2B}]}
  };
];

(* === PLOTTING PARAMETERS === *)
centroid = Mean[rootsOfP];
allPts = Join[rootsOfDerivative, rootsOfP, branchPts];
xRange = {Min[allPts[[All, 1]]], Max[allPts[[All, 1]]]};
yRange = {Min[allPts[[All, 2]]], Max[allPts[[All, 2]]]};
width = xRange[[2]] - xRange[[1]];
height = yRange[[2]] - yRange[[1]];
margin = Max[width, height]/15;
scale = Max[width, height];
triangleSize = scale/30;
rectSize = scale/100;

(* === CREATE PLOT === *)
plot = Show[Graphics[{
    (* Isodynamic lines (cubic only) *)
    isodynamicLines,
    
    (* Zeros of derivative (small red dots) *)
    {Red, PointSize[0.007], Point /@ rootsOfDerivative},
    
    (* Branch points (blue squares) *)
    {Opacity[0.7], Blue, 
     Rectangle[# - rectSize, # + rectSize] & /@ branchPts},
    
    (* Zeros of P (larger black dots) *)
    {Black, PointSize[0.025], Point /@ rootsOfP},
    
    (* Centroid marker (green triangle) *)
    {Opacity[0.9], RGBColor[0, 0.75, 0], 
     Triangle[{
       centroid + {0, triangleSize/Sqrt[3]},
       centroid + {-triangleSize/2, -triangleSize/(2 Sqrt[3])},
       centroid + {triangleSize/2, -triangleSize/(2 Sqrt[3])}
     }]}
  },
  Axes -> True,
  AxesLabel -> {"Re", "Im"},
  AspectRatio -> Automatic,
  PlotRange -> {
    {xRange[[1]] - margin, xRange[[2]] + margin},
    {yRange[[1]] - margin, yRange[[2]] + margin}
  }
]]

(* === EXPORT === *)
Export[StringJoin["RodriguesZeros-n", ToString[n], "-m", ToString[m], ".png"], 
  plot, ImageSize -> 1024];

(* Display info *)
Print["Polynomial P = ", P];
Print["Degree d = ", d];
Print["n = ", n, ", m = ", m, ", \[Alpha] = m/n = ", N[\[Alpha], 4]];
Print["Number of zeros plotted: ", Length[rootsOfDerivative]];
Print["Branch points: ", Length[branchPts]];
